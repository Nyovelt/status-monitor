# Caddyfile for Status Monitor
# Replace example.com with your actual domain

# Option 1: Separate subdomains (Recommended)
# Frontend on main domain, API on subdomain

# Frontend - Web UI
status.example.com {
    # Reverse proxy to Next.js frontend
    reverse_proxy web:3000

    # Enable compression
    encode gzip zstd

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"
        # Enable XSS protection
        X-XSS-Protection "1; mode=block"
        # Remove server header
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/status-access.log
    }
}

# Backend API - Server
api.status.example.com {
    # Reverse proxy to Rust backend
    reverse_proxy server:8080

    # Handle WebSocket connections for live updates
    @websockets {
        header Connection *Upgrade*
        header Upgrade websocket
    }
    reverse_proxy @websockets server:8080

    # Enable compression
    encode gzip zstd

    # Security headers (less strict for API)
    header {
        -Server
        X-Content-Type-Options "nosniff"
    }

    # Logging
    log {
        output file /var/log/caddy/api-access.log
    }
}

# Option 2: Single domain with path-based routing
# Uncomment and modify if you prefer everything on one domain
#
# status.example.com {
#     # Frontend - serve from root
#     reverse_proxy web:3000
#
#     # API endpoints - proxy /api/* to backend
#     handle_path /api/* {
#         reverse_proxy server:8080
#     }
#
#     # WebSocket endpoint for live updates
#     @websockets {
#         path /ws/*
#         header Connection *Upgrade*
#         header Upgrade websocket
#     }
#     reverse_proxy @websockets server:8080
#
#     encode gzip zstd
#
#     header {
#         Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#         X-Frame-Options "SAMEORIGIN"
#         X-Content-Type-Options "nosniff"
#         X-XSS-Protection "1; mode=block"
#         -Server
#     }
#
#     log {
#         output file /var/log/caddy/status-access.log
#     }
# }
